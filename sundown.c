#include <Windows.h>
#pragma comment(lib, "user32.lib")
#pragma comment(lib, "gdi32.lib")

// 1700K - 6500K (from redshift colorramp.c)
double blackbody[] = {
    1.00000000,  0.47675916,  0.00000000,
    1.00000000,  0.49923747,  0.00000000,
	1.00000000,  0.51943421,  0.00000000,
	1.00000000,  0.54360078,  0.08679949,
	1.00000000,  0.56618736,  0.14065513,
	1.00000000,  0.58734976,  0.18362641,
	1.00000000,  0.60724493,  0.22137978,
	1.00000000,  0.62600248,  0.25591950,
	1.00000000,  0.64373109,  0.28819679,
	1.00000000,  0.66052319,  0.31873863,
	1.00000000,  0.67645822,  0.34786758,
	1.00000000,  0.69160518,  0.37579588,
	1.00000000,  0.70602449,  0.40267128,
	1.00000000,  0.71976951,  0.42860152,
	1.00000000,  0.73288760,  0.45366838,
	1.00000000,  0.74542112,  0.47793608,
	1.00000000,  0.75740814,  0.50145662,
	1.00000000,  0.76888303,  0.52427322,
	1.00000000,  0.77987699,  0.54642268,
	1.00000000,  0.79041843,  0.56793692,
	1.00000000,  0.80053332,  0.58884417,
	1.00000000,  0.81024551,  0.60916971,
	1.00000000,  0.81957693,  0.62893653,
	1.00000000,  0.82854786,  0.64816570,
	1.00000000,  0.83717703,  0.66687674,
	1.00000000,  0.84548188,  0.68508786,
	1.00000000,  0.85347859,  0.70281616,
	1.00000000,  0.86118227,  0.72007777,
	1.00000000,  0.86860704,  0.73688797,
	1.00000000,  0.87576611,  0.75326132,
	1.00000000,  0.88267187,  0.76921169,
	1.00000000,  0.88933596,  0.78475236,
	1.00000000,  0.89576933,  0.79989606,
	1.00000000,  0.90198230,  0.81465502,
	1.00000000,  0.90963069,  0.82838210,
	1.00000000,  0.91710889,  0.84190889,
	1.00000000,  0.92441842,  0.85523742,
	1.00000000,  0.93156127,  0.86836903,
	1.00000000,  0.93853986,  0.88130458,
	1.00000000,  0.94535695,  0.89404470,
	1.00000000,  0.95201559,  0.90658983,
	1.00000000,  0.95851906,  0.91894041,
	1.00000000,  0.96487079,  0.93109690,
	1.00000000,  0.97107439,  0.94305985,
	1.00000000,  0.97713351,  0.95482993,
	1.00000000,  0.98305189,  0.96640795,
	1.00000000,  0.98883326,  0.97779486,
	1.00000000,  0.99448139,  0.98899179,
	1.00000000,  1.00000000,  1.00000000,
};

int supports() {
    HDC dc = GetDC(NULL);
    int caps = GetDeviceCaps(dc, COLORMGMTCAPS);
    ReleaseDC(NULL, dc);
    return caps & CM_GAMMA_RAMP? 1: 0;
}
void help() {
    puts("usage:");
    puts("sundown [reset|temperature]");
    puts("temperatures: between (1700 - 6500)");
    puts("2800K     Incandescent lamp");
    puts("3000K     Soft compact fluorescent lamp");
    puts("5000K     Cool compact fluorescent lamp");
    puts("6500K     Daylight");
    if (!supports())
        puts("\aDisplay does not support gamma correction");
    
}
int fill_buffer(WORD *buffer, int temp) {
    if (temp < 1700 || temp > 6500)
        return 0;
    temp = temp / 100 - 17;
    
    double  rs = blackbody[temp*3];
    double  gs = blackbody[temp*3+1];
    double  bs = blackbody[temp*3+2];
    WORD    *rb = buffer;
    WORD    *gb = buffer + 256;
    WORD    *bb = buffer + 512;
    for (int i = 0; i < 256; i++) {
        *rb++ = (int)(i * rs) << 8;
        *gb++ = (int)(i * gs) << 8;
        *bb++ = (int)(i * bs) << 8;
    }
    return 1;
}
int main(int argc, char **argv) {
    if (!argv[1]) {
        help();
        return 1;
    }
    
    WORD ramps[3*256*sizeof(WORD)];
    int temp = strtol(argv[1], NULL, 10);
    if (!strcmp(argv[1], "reset"))
        temp = 6500;
    if (!fill_buffer(ramps, temp)) {
        help();
        return 1;
    }
    
    HDC dc = GetDC(NULL);
    SetDeviceGammaRamp(dc, ramps);
    ReleaseDC(NULL, dc);
    return 0;
}
